# For a detailed guide to building and testing on iOS, read the docs:
# https://circleci.com/docs/2.0/testing-ios/

version: 2.1

executors:
  mac-executor:
    macos:
      xcode: "11.2.1"
    working_directory: ~/code

jobs:
  install_dependendies:
    executor: mac-executor
    steps:
      - checkout
      - run:
          name: Bundler
          command: |
            bundle config --local path vendor/bundle
            bundle install --jobs 4 --retry 3
      - persist_to_workspace:
          root: .
          paths:
            - .
  test:
    executor: mac-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/code
      - run:
          name: Test
          command: |
            bundle config --local path vendor/bundle
            bundle exec fastlane test
      - run:
          name: Sonarqube
          command: |
            bundle config --local path vendor/bundle
            bundle exec fastlane sonarqube
      # Collect XML test results data to show in the UI, and save the same XML
      # files under test-results folder in the Artifacts tab
      - store_test_results:
          path: fastlane/test_output
      - store_artifacts:
          path: fastlane/test_output
          destination: scan-output

  danger:
    executor: mac-executor
    steps:
      - checkout
      - attach_workspace:
          at: ~/code
      - run:
          name: Danger
          command: |
            bundle config --local path vendor/bundle
            bundle exec danger

workflows:
  version: 2
  workflow:
    jobs:
      - install_dependendies
      - test:
          requires:
            - install_dependendies
      - danger:
          requires:
            - install_dependendies
